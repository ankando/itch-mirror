name: Mirror Mindustry Itch Builds

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/*.yml'

jobs:
  mirror:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up environment
        run: |
          sudo apt-get update
          sudo apt-get install -y curl
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Download files from itch.io
        run: |
          mkdir -p builds
          ~/.local/bin/uvx itch-dl https://anuke.itch.io/mindustry \
            --api-key "${{ secrets.ITCH_API_KEY }}" \
            --download-to builds
            
      - name: check downloaded files
        run: |
             ls -R builds
             rm -rf builds/anuke/mindustry/files/*32-bit*

      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v2
        with:
          tag_name: itch-mirror
          name: ${{ steps.date.outputs.date }}
          files: builds/anuke/mindustry/files/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
