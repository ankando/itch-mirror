name: Mirror Mindustry Itch Builds

on:
  schedule:
    - cron: '0 0 * * *'  # 每天 UTC 0 点
  push:
  workflow_dispatch:

jobs:
  mirror:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (fetch all tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Download Itch.io Builds
        env:
          ITCH_API_KEY: ${{ secrets.ITCH_API_KEY }}
        run: |
          mkdir -p builds
          cd builds
          uvx itch-dl https://anuke.itch.io/mindustry --api-key "$ITCH_API_KEY"

      - name: Prepare git repo for tag push
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          # Clean untracked files so orphan branch works
          git clean -fdx

          # Create orphan branch (no history)
          git checkout --orphan temp-mirror

          # Remove all files from index
          git rm -rf . || true

          # Copy downloaded files to root
          cp -r builds/anuke/mindustry/files/* ./

          # Commit and push tag
          git add .
          git commit -m "Update itch-mirror from Itch.io"

          # Delete old tag (if any)
          git tag -d itch-mirror || true
          git push origin :refs/tags/itch-mirror || true

          # Create and push new tag
          git tag itch-mirror
          git push origin itch-mirror --force
