name: Mirror Mindustry Itch Builds

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/*.yml'

jobs:
  mirror:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up environment
        run: |
          sudo apt-get update
          sudo apt-get install -y curl
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Download files from itch.io
        run: |
          mkdir -p builds
          ~/.local/bin/uvx itch-dl https://anuke.itch.io/mindustry \
            --api-key "${{ secrets.ITCH_API_KEY }}" \
            --download-to builds
            
      - name: check downloaded files
        run: |
             ls -R builds
             rm -rf builds/anuke/mindustry/files/*32-bit*
             echo "version=itch-mirror" >> $GITHUB_OUTPUT

      - name: Check if remote tag exists
        id: check_tag
        run: |
          TAG="v${{ steps.get_version.outputs.version }}"
          if git ls-remote --tags origin | grep -q "refs/tags/$TAG$"; then
            echo "tag_exists=true" >> $GITHUB_OUTPUT
          else
            echo "tag_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create tag if not exists
        if: steps.check_tag.outputs.tag_exists == 'false'
        run: |
          TAG="v${{ steps.get_version.outputs.version }}"
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"
          git tag "$TAG"
          git push origin "$TAG"


      - name: Upload Release Asset
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.get_version.outputs.version }}
          name: Release v${{ steps.get_version.outputs.version }}
          files: builds/anuke/mindustry/files/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
