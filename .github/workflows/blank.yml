name: Mirror Mindustry Itch Builds

on:
  schedule:
    - cron: '0 0 * * *'  # 每天 UTC 0 点
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/*.yml'

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install itchio-downloader
        run: |
          # 下载最新版本并安装到 PATH
          LATEST_VERSION=$(curl -s "https://api.github.com/repos/BraedonWooding/itch-downloader/releases/latest" | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
          DOWNLOAD_URL="https://github.com/BraedonWooding/itch-downloader/releases/download/$LATEST_VERSION/itch-downloader-x86_64-unknown-linux-gnu"
          curl -L -o itch-downloader "$DOWNLOAD_URL"
          chmod +x itch-downloader
          sudo mv itch-downloader /usr/local/bin/

      - name: Create Downloads Directory
        run: mkdir -p downloads

      - name: Download Mindustry Builds
        env:
          ITCH_API_KEY: ${{ secrets.ITCH_API_KEY }}  # 需要在仓库设置中添加此 secret
        run: |
          itch-downloader dl \
            --author "anuke" \
            --title "Mindustry" \
            --output downloads \
            --max-concurrent 4

      - name: Compress Downloads
        run: |
          tar czvf mindustry-builds-$(date +%Y%m%d).tar.gz downloads/
          ls -lh *.tar.gz

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: itch-mirror-${{ github.run_id }}
          files: mindustry-builds-*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup
        run: |
          rm -rf downloads/
          rm -f mindustry-builds-*.tar.gz
